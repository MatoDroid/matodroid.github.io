<!DOCTYPE html>
<html>
<head>
    <title>Overpass API</title>
    <style>
        /* Štýly pre tabuľku (skrytá na začiatku) */
        #vystup table {
            display: none;
        }

        /* Štýly pre tabuľku po zobrazení */
        #vystup table.visible {
            display: table;
            border-collapse: collapse;
            width: auto; /* Nastavenie šírky tabuľky na auto */
        }

        #vystup table.visible th, #vystup table.visible td {
            border: none;
            padding: 8px;
            text-align: left;
        }

        /* Farebné zvýraznenie prvého riadka */
        #vystup table.visible tr:first-child {
            background-color: #f2f2f2;
        }

        /* Farebné zvýraznenie prvého stĺpca */
        #vystup table.visible th:first-child {
            background-color: #f2f2f2;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <label for="obceInput">Zadajte obec:</label>
    <input type="text" id="obceInput">
    <button id="spracovatButton">Spracovať</button>
    
    <!-- Div na zobrazenie získaných údajov -->
    <div id="vystup">
        <h2>Vystup udajov:</h2>
    </div>

    <script>
        var id = null;

        // Funkcia na extrakciu čísel z textového reťazca s písmenami
        function extrahujCislo(s) {
            const cislo = parseInt(s, 10);
            return isNaN(cislo) ? 0 : cislo;
        }

        // Funkcia na nastavenie šírky stĺpcov tabuľky
        function nastavSirkuStlpcov(tabulka) {
            tabulka.find('tr').first().find('th, td').each(function (index, th) {
                var maxSirka = 0;

                tabulka.find('tr').not(':first').each(function () {
                    var bunka = $(this).find('td').eq(index);
                    var obsah = bunka.text();
                    bunka.css('width', 'auto'); // Nastavte šírku na auto pred meraním
                    var sirka = bunka.width();

                    if (sirka > maxSirka) {
                        maxSirka = sirka;
                    }
                });

                $(th).css('width', maxSirka + 'px');
            });
        }

        $(document).ready(function () {
            // Načítajte CSV súbor
            $.ajax({
                type: "GET",
                url: "obce.csv",
                dataType: "text",
                success: function (data) {
                    var lines = data.split("\n");
                    var autocompleteData = [];

                    for (var i = 0; i < lines.length; i++) {
                        var values = lines[i].split(",");
                        if (values.length >= 1) {
                            autocompleteData.push(values[0]);
                        }
                    }

                    // Inicializujte auto-dopĺňanie
                    $("#obceInput").autocomplete({
                        source: autocompleteData
                    });
                }
            });

            // Obsluha kliknutia na tlačidlo "Spracovať"
            $("#spracovatButton").click(function () {
                var vybranyName = $("#obceInput").val();

                $.ajax({
                    type: "GET",
                    url: "obce.csv",
                    dataType: "text",
                    success: function (data) {
                        var lines = data.split("\n");

                        for (var i = 0; i < lines.length; i++) {
                            var values = lines[i].split(",");
                            if (values.length >= 2 && values[0] === vybranyName) {
                                id = values[1];

                                // Upravený kód pre Overpass API dotaz s použitím fetch
                                var overpassQuery = `
                                    [out:csv("ref:minvskaddress","addr:street","addr:streetnumber","addr:conscriptionnumber")];
                                    area(${id})->.searchArea;

                                    (
                                    node["addr:conscriptionnumber"](area.searchArea);
                                    way["addr:conscriptionnumber"](area.searchArea);
                                    relation["addr:conscriptionnumber"](area.searchArea);
                                    );
                                    out center;
                                `;

                                fetch('https://overpass-api.de/api/interpreter', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded'
                                    },
                                    body: `data=${encodeURIComponent(overpassQuery)}`
                                })
                                .then(response => response.text())
                                .then(data => {
                                    // Spracovať výsledky z Overpass API
                                    var resultLines = data.split('\n'); // Rozdeliť výsledky na riadky
                                    var firstResult = resultLines[0]; // Prvý riadok

                                    var sortedResults = []; // Pole pre usporadané výsledky

                                    // V cykle pre spracovanie zvyšku výsledkov Overpass API
                                    for (var i = 1; i < resultLines.length; i++) {
                                        var resultValues = resultLines[i].split('\t'); // Rozdeliť riadok na hodnoty
                                        if (resultValues.length >= 4) {
                                            // Stĺpec "addr:conscriptionnumber" je na 4. pozícii (index 3)
                                            var conscriptionNumber = resultValues[3];
                                            sortedResults.push({
                                                conscriptionNumber: conscriptionNumber,
                                                resultLine: resultLines[i]
                                            });
                                        }
                                    }

                                    // Usporiadať výsledky podľa "addr:conscriptionnumber" (čísla)
                                    sortedResults.sort(function (a, b) {
                                        return a.conscriptionNumber - b.conscriptionNumber;
                                    });

                                    //Usporiadať výsledky podľa "addr:streetnumber" (čísla a text)
                                    sortedResults.sort(function (a, b) {
                                        var streetNumA = extrahujCislo(a.resultLine.split('\t')[2]);
                                        var streetNumB = extrahujCislo(b.resultLine.split('\t')[2]);

                                        // Porovnanie podľa čísel
                                        if (streetNumA !== streetNumB) {
                                            return streetNumA - streetNumB;
                                        } else {
                                            // Ak sú čísla rovnaké, usporiadajte podľa textu v "addr:streetnumber"
                                            var streetNumA = a.resultLine.split('\t')[2];
                                            var streetNumB = b.resultLine.split('\t')[2];
                                            return streetNumA.localeCompare(streetNumB);
                                        }
                                    });

                                    // Ďalej usporiadajte podľa "addr:street"
                                    sortedResults.sort(function (a, b) {
                                        var streetA = a.resultLine.split('\t')[1];
                                        var streetB = b.resultLine.split('\t')[1];
                                        return streetA.localeCompare(streetB);
                                    });

                                    // Zobraziť usporiadané výsledky v tabuľke
                                    var vystupElement = $("#vystup");
                                    vystupElement.empty(); // Vyprázdniť obsah divu

                                    // Pridajte tabuľku a nastavte jej triedu na "visible", aby sa zobrazila
                                    var table = $("<table>").addClass("visible");
                                    vystupElement.append(table);

                                    for (var j = 0; j < sortedResults.length; j++) {
                                        var resultValues = sortedResults[j].resultLine.split('\t');
                                        if (resultValues.length >= 4) {
                                            var conscriptionNumber = resultValues[3];
                                            var street = resultValues[1];
                                            var streetNumber = resultValues[2];

                                            // Pridaj nový riadok s údajmi do tabuľky
                                            var newRow = $("<tr>");
                                            newRow.append("<td>" + conscriptionNumber + "</td>");
                                            newRow.append("<td>" + street + "</td>");
                                            newRow.append("<td>" + streetNumber + "</td>");
                                            newRow.append("<td>" + conscriptionNumber + "</td>");
                                            table.append(newRow);
                                        }
                                    }

                                    // Nastavte šírku stĺpcov podľa obsahu
                                    nastavSirkuStlpcov(table);
                                })
                                .catch(error => {
                                    console.error('Chyba pri vykonávaní dotazu na Overpass API:', error);
                                });
                                break;
                            }
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
